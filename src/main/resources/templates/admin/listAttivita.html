<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

	
	<nav th:insert="~{fragments/navigation :: block-navigation('Elenco attivita')}"></nav>



	<div class="container mt-3" align="center">

	<!-- Gestione errore messaggi generate dal popup  -->
	<div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
  		<span th:text="${errorMessage}">*</span>
  		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>
	</div>

	<div align="center" class="container  mt-3">
		<table class="table table-secondary w-50">
			<thead>
				<tr align="center">
					<th>Descrizione</th>
					<th>Prezzo</th>
					<th>
						<a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#attivitaModal"
   							onclick="clearForm()">Crea attività</a>					
   					</th>
				</tr>
			</thead>
			<tbody>
				<!-- th:attr elenco dei attibuti da passare al javascript -->
				<tr th:each="att : ${attivita.dati}"
	    				class="clickable-row"
	    				th:attr="data-id=${att.id}, data-descrizione=${att.descrizione}, data-prezzo=${att.prezzo}"
	    				style="cursor: pointer;">
	    			<td th:text="${att.descrizione}" align="center"></td>
	    			<td th:text="${att.prezzo}" align="center"></td>
	    			<td></td>
				</tr>
			</tbody>
		</table>
	</div>


	<!-- 
		Definizione della modale di creazione/aggiornamento	
	 -->
	<div class="modal fade" id="attivitaModal" tabindex="-1" aria-labelledby="attivitaModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <form th:action="@{/admin/saveAttivita}" method="post">
	        <div class="modal-header">
	          <h5 class="modal-title" id="attivitaModalLabel">Gestione Attività</h5>
	          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
	        </div>
	        <div class="modal-body">
	          <input type="hidden" name="id" id="attivita-id"/> <!-- parametro d passare al bakend -->
	
	          <div class="mb-3">
	            <label class="form-label">Descrizione</label>
	            <input type="text" class="form-control" name="descrizione" id="attivita-descrizione" required/>
	          </div>
	
	          <div class="mb-3">
	            <label class="form-label">Prezzo</label>
	            <input type="number" class="form-control" name="prezzo" id="attivita-prezzo" required step="0.01"/>
	          </div>
	        </div>
	        <div class="modal-footer">
	          	<button type="submit" class="btn btn-success">Salva</button>
	          	<a id="delete-button" class="btn btn-danger d-none"
   					href="#"
   					onclick="return confirm('Sei sicuro di voler rimuovere quest\'attività?');">
   				<span>Cancella attività</span>
			 	</a>
	         	<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
	        </div>
	      </form>
	    </div>
	  </div>
	</div>

	<!-- Script di gestione della modale -->
	<script>
	document.addEventListener("DOMContentLoaded", function () {
	    const rows = document.querySelectorAll(".clickable-row"); 
	    rows.forEach(row => {
	      row.addEventListener("click", () => {
	        const id = row.getAttribute("data-id");
	        const descrizione = row.getAttribute("data-descrizione");
	        const prezzo = row.getAttribute("data-prezzo");

	        // Imposta i valori nel form
	        document.getElementById("attivita-id").value = id;
	        document.getElementById("attivita-descrizione").value = descrizione;
	        document.getElementById("attivita-prezzo").value = prezzo;
	        document.getElementById("attivitaModalLabel").innerText = 'Modifica Attività';
	        
		    // Imposta href per il bottone di cancellazione
            const deleteBtn = document.getElementById("delete-button");
            deleteBtn.href = `/admin/removeAttivita?id=${id}`;
            deleteBtn.classList.remove("d-none");


	        // Mostra la modale
	        const modal = new bootstrap.Modal(document.getElementById('attivitaModal'));
	        modal.show();
	      });
	    });
	  });	  

	function clearForm() {
	    document.getElementById("attivita-id").value = '';
	    document.getElementById("attivita-descrizione").value = '';
	    document.getElementById("attivita-prezzo").value = '';
	    document.getElementById("attivitaModalLabel").innerText = 'Nuova Attività';
	    
	    // Nasconde il pulsante di cancellazione
	    const deleteBtn = document.getElementById("delete-button");
	    deleteBtn.href = '#';
	    deleteBtn.classList.add("d-none");

	  }
	</script>

</body>
</html>